{"version":3,"file":"fetch2.js","sources":["../src/url-params.js","../src/index.js","../node_modules/rollup-plugin-node-globals/src/global.js"],"sourcesContent":["\r\nfunction isArr (val) {\r\n  return Object.prototype.toString.call(val) === '[object Array]'\r\n}\r\n\r\n/**\r\n* 把参数对象序列化成树对象\r\n*\r\n**/\r\nfunction ObjTree (obj) {\r\n  var arr = []\r\n  for (var key in obj) {\r\n    if (typeof obj[key] === 'object') {\r\n      arr.push({label: key, child: ObjTree(obj[key])})\r\n    } else {\r\n      arr.push({label: key, val: obj[key]})\r\n    }\r\n  }\r\n  return arr\r\n}\r\n/**\r\n* 从对象树种遍历所有路径，及叶子\r\n*\r\n**/\r\nfunction ObjTreePaths (tree) {\r\n  var arr = []\r\n  // 路径遍历\r\n  function path (tree, label) {\r\n    label = label || ''\r\n    for (var i in tree) {\r\n      if (tree[i].child) {\r\n        if (label) {\r\n          path(tree[i].child, label + '[' + tree[i].label + ']')\r\n        } else {\r\n          path(tree[i].child, tree[i].label)\r\n        }\r\n      } else {\r\n        // 把叶子值连接到路径后面\r\n        if (label) {\r\n          arr.push(label + '[' + tree[i].label + ']=' + tree[i].val)\r\n        } else {\r\n          arr.push(tree[i].label + '=' + tree[i].val)\r\n        }\r\n      }\r\n    }\r\n  }\r\n  path(tree)\r\n  return arr\r\n}\r\n\r\nfunction URLParams (obj, encode) {\r\n  if (typeof obj === 'object' && !isArr(obj)) {\r\n    var paths = ObjTreePaths(ObjTree(obj))\r\n    var qs = paths.join('&')\r\n    return encode ? encodeURI(qs) : qs\r\n  }\r\n  return ''\r\n}\r\n\r\nexport default {\r\n  url: (url, obj, encode) => {\r\n    var params = URLParams(obj, encode)\r\n    if (url.indexOf('?') > -1) {\r\n      var uri = url.split('?')\r\n      return params ? (url.replace(/&$/, '') + (uri[1] ? '&' : '') + params) : url\r\n    } else {\r\n      return params ? url + '?' + params : url\r\n    }\r\n  },\r\n  stringify: (obj, encode) => {\r\n    return URLParams(obj, encode)\r\n  }\r\n}\r\n","import URLParams from './url-params'\r\nvar _self = (typeof self === 'object' && self.self === self) && self\r\nvar _global = (typeof global === 'object' && global.global === global) && global\r\nvar root = _self || _global\r\n\r\nvar Fetch = root.fetch || null\r\nvar FormData = root.FormData\r\n\r\n\r\nfunction Fetch2 () {}\r\n\r\nFetch2.prototype.request = {\r\n  interceptors: [],\r\n  use (fn) {\r\n    if (typeof fn !== 'function') {\r\n      console.warn('the interceptors must be a function')\r\n      return false\r\n    }\r\n    this.interceptors.push(fn)\r\n    return true\r\n  }\r\n}\r\n\r\nFetch2.prototype.response = {\r\n  interceptors: [],\r\n  use (fn) {\r\n    if (typeof fn !== 'function') {\r\n      console.warn('the interceptors must be a function')\r\n      return false\r\n    }\r\n    this.interceptors.push(fn)\r\n    return true\r\n  }\r\n}\r\n\r\n/**\r\n* 3xx-5xx responses are NOT network errors, and should be handled in then()\r\n**/\r\nFetch2.prototype.fetch = function (uri, method, options = {}) {\r\n  var that = this\r\n  method = method ? method.toUpperCase() : 'GET'\r\n  // Request with GET/HEAD method cannot have body.\r\n  if (method === 'GET' || method === 'HEAD') {\r\n    delete options.body\r\n  }\r\n  var isTransion = (typeof options.body === 'object') && !(options.body instanceof FormData)\r\n  // 对于formData数据，并不需要指定Content-Type\r\n  if (isTransion || typeof options.body === 'string') {\r\n    if (!options.headers) options.headers = {}\r\n    options.headers['Content-Type'] = 'application/x-www-form-urlencoded'\r\n  }\r\n  if (isTransion) {\r\n    options.body = URLParams.stringify(options.body)\r\n  }\r\n  // var opts = Object.assign({}, {method}, options)\r\n  options.method = method\r\n  var opts = options\r\n  return new Promise((resolve, reject) => {\r\n    function request () {\r\n      // 响应过滤器\r\n      function response (res) {\r\n        var interceptors = that.response.interceptors\r\n        if (interceptors.length === 0) {\r\n          resolve(res)\r\n          return true\r\n        }\r\n        var v = 0\r\n        function run () {\r\n          if (v >= interceptors.length) {\r\n            resolve(res)\r\n            return true\r\n          }\r\n          var interceptor = interceptors[v]\r\n          v++\r\n          if (interceptor && typeof interceptor === 'function') {\r\n            interceptor(res, run)\r\n          }\r\n        }\r\n        run()\r\n      }\r\n      var url = URLParams.url(uri, opts.params)\r\n      Fetch(url, opts).then(res => {\r\n        switch (options.type) {\r\n          case 'text':\r\n            res.text().then(text => {\r\n              res.data = text\r\n              response(res)\r\n            })\r\n            break\r\n          case 'blob':\r\n            res.blob().then(blob => {\r\n              res.data = blob\r\n              response(res)\r\n            })\r\n            break\r\n          case 'arrayBuffer':\r\n            res.arrayBuffer().then(buffer => {\r\n              res.data = buffer\r\n              response(res)\r\n            })\r\n            break\r\n          default:\r\n            res.json().then(json => {\r\n              res.data = json\r\n              response(res)\r\n            }).catch(err => reject(err))\r\n        }\r\n      }).catch(err => {\r\n        reject(err)\r\n      })\r\n    }\r\n    var interceptors = that.request.interceptors\r\n    if (interceptors.length === 0) {\r\n      request()\r\n      return true\r\n    }\r\n    var v = 0\r\n    function run () {\r\n      if (v >= interceptors.length) {\r\n        request()\r\n        return true\r\n      }\r\n      var interceptor = interceptors[v]\r\n      v++\r\n      if (interceptor && typeof interceptor === 'function') {\r\n        interceptor(opts, run)\r\n      }\r\n    }\r\n    run()\r\n  })\r\n}\r\n\r\nFetch2.prototype.URLParams = URLParams\r\n\r\n// for node-fetch\r\nFetch2.prototype.init = function (fetch, formData) {\r\n  Fetch = fetch\r\n  FormData = formData\r\n}\r\n\r\nFetch2.prototype.Fetch2 = Fetch2\r\n\r\nFetch2.prototype.get = function (uri, options) {\r\n  return this.fetch(uri, 'GET', options)\r\n}\r\n\r\nFetch2.prototype.post = function (uri, options) {\r\n  return this.fetch(uri, 'POST', options)\r\n}\r\n\r\nFetch2.prototype.put = function (uri, options) {\r\n  return this.fetch(uri, 'PUT', options)\r\n}\r\n\r\nFetch2.prototype.delete = function (uri, options) {\r\n  return this.fetch(uri, 'DELETE', options)\r\n}\r\n\r\nFetch2.prototype.head = function (uri, options) {\r\n  return this.fetch(uri, 'HEAD', options)\r\n}\r\n\r\nFetch2.prototype.patch = function (uri, options) {\r\n  return this.fetch(uri, 'PATCH', options)\r\n}\r\n\r\nvar fetch2 = new Fetch2()\r\n\r\nexport default fetch2\r\n","export default typeof global !== \"undefined\" ? global :\n            typeof self !== \"undefined\" ? self :\n            typeof window !== \"undefined\" ? window : {}\n"],"names":["isArr","val","Object","prototype","toString","call","ObjTree","obj","arr","key","babelHelpers.typeof","push","label","child","ObjTreePaths","tree","path","i","URLParams","encode","qs","join","encodeURI","Fetch2","global","self","window","url","params","indexOf","uri","split","replace","_self","_global","root","Fetch","fetch","FormData","request","fn","warn","interceptors","response","method","options","that","this","toUpperCase","body","isTransion","headers","stringify","opts","Promise","resolve","reject","res","run","v","length","interceptor","then","type","text","data","blob","arrayBuffer","buffer","json","catch","err","init","formData","get","post","put","delete","head","patch"],"mappings":"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"}